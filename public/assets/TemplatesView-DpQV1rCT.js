import{u as ie}from"./useTitleSetter-BolkDrrI.js";import{P as oe}from"./permission-Ba-8wP-4.js";import{E as se,T as s,a as ne}from"./Editor-DvZO7T0P.js";import{G as ue}from"./group-Dg_peWef.js";import{C as re}from"./canDo-DmjiwSfW.js";import{i as K,N as me,$ as Q,n as V,q as S,B as E,D as H,r as T,w as M,c as de,F as ve,f as t,v as a,A as y,k as h,x as C,m as q,G as f,y as D,P as Te,V as pe}from"./index-Dz-KKuQk.js";import{G as fe}from"./userData-3wLL-Kql.js";import{_ as Ee}from"./ModelDialog.vue_vue_type_script_setup_true_lang-BPo4Cy__.js";import{b as ce}from"./sorted-PYsDa1V2.js";import{u as Ie}from"./useConventionForms-3aMPB8e5.js";import{V as Ne}from"./VSheet-D_uuRr5x.js";import{e as L,V as x,d as z}from"./VContainer-BB-0N338.js";import{V as N,a as r}from"./VRow-DGWxrdlo.js";import{V as U}from"./VSelect-C4lJezO_.js";import{V as Ve,a as J}from"./VList-DnZSDUIF.js";import{V as G}from"./VTextField-DE157IIp.js";import{v as _e}from"./v4-CtRu48qb.js";import"./SaveButton.vue_vue_type_script_setup_true_lang-B0Z8sE7n.js";import"./VOverlay-y6013gX9.js";import"./forwardRefs-CRsfwDW6.js";import"./scopeId-u7C7Bp9Y.js";import"./createSimpleFunctional-BDDu5rC0.js";import"./layout-C7ZoiN8H.js";import"./VCard-CKyVBRSl.js";import"./VToolbar-XOdzjqCn.js";import"./VDialog-CEC9GBIC.js";import"./form-DAjrK8OW.js";import"./VCheckboxBtn-BTzL2OqH.js";import"./VChip-BVwUWGS9.js";import"./VDivider-BjCDkuE5.js";const Oe=_=>_===void 0?!1:re(_,ue.GROUP_TYPE_SYSTEM).EditOrganisation,Ue=K({__name:"HTMLEditor",props:{modelValue:{},modelModifiers:{}},emits:["update:modelValue"],setup(_,{expose:v}){const c={license_key:"gpl",content_style:"body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }"},I=me(_,"modelValue"),A=Q("editBox");return v({insertText:O=>{A.value&&A.value.getEditor().execCommand("mceInsertContent",!1,O)}}),(O,i)=>(V(),S(E(se),{modelValue:I.value,"onUpdate:modelValue":i[0]||(i[0]=n=>I.value=n),"license-key":"gpl",plugins:"advlist code emoticons link lists table",init:c,ref:"editBox"},null,8,["modelValue"]))}}),ll=K({__name:"TemplatesView",props:{loggedIn:{type:Boolean}},async setup(_){let v,c;ie("Email Templates");const I=Te(),A=fe(),{Conventions:w,Organisations:O}=([v,c]=H(()=>I.getPermissionAccessList(oe.PERMISSION_TYPE_EDIT_CONVENTION)),v=await v,c(),v),i=T(),n=T(),R=T(!1),m=T(),p=T(([v,c]=H(()=>I.getEmailTemplates()),v=await v,c(),v)),d=T("SYSTEM"),P=T([]),g=T(),W=T([{title:"Account Display Name",subtitle:"The users current profile name",value:"ACCOUNT_DISPLAY_NAME"},{title:"Email Login Recovery URL",subtitle:"One use URL for a user to access their account.",value:"ACCOUNT_RECOVERY_URL"},{title:"Convention Name",subtitle:"The convention's name",value:"CONVENTION_NAME"},{title:"Email Verification URL",subtitle:"URL used to confirm a users email address",value:"EMAIL_VERIFICATION_URL"},{title:"Organisation Name",subtitle:"The organisation's name",value:"ORGANISATION_NAME"},{title:"Form Name",subtitle:"Name of the form that triggered this email",value:"SUBMISSION_FORM_NAME"},{title:"Registration Reference",subtitle:"Unique reference for this registration. E.g. Badge number",value:"REGISTRATION_REFERENCE"},{title:"Submission Details",subtitle:"Auto-generated details of ticket, accommodation, cost etc.",value:"SUBMISSION_DETAILS"}]),Y=T(),b=[],F=Q("editor");Oe(A)&&b.push({title:"System",value:s.TARGET_TYPE_SYSTEM}),O.length>0&&b.push({title:"Organisational",value:s.TARGET_TYPE_ORGANISATION}),w.length>0&&b.push({title:"Convention",value:s.TARGET_TYPE_CONVENTION}),M(d,()=>{d.value==s.TARGET_TYPE_SYSTEM?(n.value=void 0,m.value=void 0):d.value==s.TARGET_TYPE_ORGANISATION&&(n.value=void 0)}),M(m,()=>{m.value&&n.value&&m.value.OrganisationUUID!==n.value.OrganisationUUID&&(n.value=void 0)}),M(n,()=>{le()});const k=()=>{var o;return{ID:0,EmailTemplateUUID:_e(),Name:"",Title:"",OwnerUUID:d.value===s.TARGET_TYPE_SYSTEM?pe:d.value===s.TARGET_TYPE_ORGANISATION?m.value.OrganisationUUID:n.value.ConventionUUID,OwnerType:((o=ne.find(l=>l.value===d.value))==null?void 0:o.value)||s.TARGET_TYPE_SYSTEM,From:"",FromName:"",Subject:"",HTML:"",AutoText:!0,Text:""}},X=de(()=>{switch(d.value){case s.TARGET_TYPE_SYSTEM:return p.value.filter(o=>o.OwnerType===s.TARGET_TYPE_SYSTEM);case s.TARGET_TYPE_ORGANISATION:return!m.value||!m.value.OrganisationUUID?[]:p.value.filter(o=>o.OwnerType===s.TARGET_TYPE_ORGANISATION&&o.OwnerUUID===m.value.OrganisationUUID);case s.TARGET_TYPE_CONVENTION:return!n.value||!n.value.ConventionUUID?[]:p.value.filter(o=>o.OwnerType===s.TARGET_TYPE_CONVENTION&&o.OwnerUUID===n.value.ConventionUUID)}return[]}),Z=()=>{const o=p.value.findIndex(l=>i.value&&l.EmailTemplateUUID===i.value.EmailTemplateUUID);o===-1?i.value=k():i.value=h(p.value[o])},B=(o=void 0)=>{o===void 0?i.value=k():i.value=h(o),R.value=!0},ee=async o=>{if(i.value)try{const l=await I.saveEmailTemplate(i.value);if(l){const e=p.value.findIndex(u=>u.EmailTemplateUUID===l.EmailTemplateUUID);e===-1?p.value.push(l):p.value.splice(e,1,l),await o("Template Saved"),setTimeout(()=>{i.value=void 0,R.value=!1},500)}else await o("Failed to Save")}catch{await o("Failed to Save")}},$=o=>{F.value&&F.value.insertText(o)},le=async()=>{if(!n.value)return;const o=await Ie(n.value.ConventionUUID);o&&(o.forEach(l=>l.Sections.forEach(e=>e.Fields&&P.value.push(...e.Fields.map(u=>{var j;return{subtitle:`${l.Name} - ${e.Name}`,title:`${(j=u.Field)==null?void 0:j.Name}`,value:u.SectionFieldUUID,object:u}})))),P.value.sort(ce("title")))},te=()=>{$(`[%FORM_${g.value.title}_${g.value.value}%]`)},ae=()=>{$(`[%${Y.value.value}%]`)};return(o,l)=>(V(),ve("div",null,[t(Ne,null,{default:a(()=>[t(L,{class:"bg-secondary",fluid:""},{default:a(()=>[t(N,null,{default:a(()=>[t(r,{cols:"12",sm:"5",md:"3",xl:"2",class:"pa-0"},{default:a(()=>[t(U,{modelValue:d.value,"onUpdate:modelValue":l[0]||(l[0]=e=>d.value=e),label:"Level",items:b,"hide-details":""},null,8,["modelValue"])]),_:1}),d.value===E(s).TARGET_TYPE_ORGANISATION||d.value===E(s).TARGET_TYPE_CONVENTION?(V(),S(r,{key:0,cols:"12",sm:"7",md:"4",lg:"3",xl:"2",class:"pa-0"},{default:a(()=>[t(U,{modelValue:m.value,"onUpdate:modelValue":l[1]||(l[1]=e=>m.value=e),label:"Organisation",items:E(O).sort((e,u)=>e.Name.localeCompare(u.Name)),"item-title":"Name","item-value":e=>e,clearable:"","hide-details":""},null,8,["modelValue","items","item-value"])]),_:1})):y("",!0),d.value===E(s).TARGET_TYPE_CONVENTION?(V(),S(r,{key:1,cols:"12",md:"5",lg:"6",xl:"4",class:"pa-0"},{default:a(()=>[t(U,{modelValue:n.value,"onUpdate:modelValue":l[2]||(l[2]=e=>n.value=e),label:"Convention",items:E(w).filter(e=>!m.value||e.OrganisationUUID===m.value.OrganisationUUID).sort((e,u)=>e.Name.localeCompare(u.Name)),"item-title":"Name","item-value":e=>e,clearable:"","hide-details":""},null,8,["modelValue","items","item-value"])]),_:1})):y("",!0)]),_:1})]),_:1}),t(L,{fluid:""},{default:a(()=>[t(Ve,{items:X.value,"item-value":e=>e,"item-title":"Title"},{append:a(({item:e})=>[t(x,{color:"primary","prepend-icon":"mdi:mdi-pencil",onClick:u=>B(e)},{default:a(()=>l[12]||(l[12]=[C(" Edit ")])),_:2},1032,["onClick"])]),_:1},8,["items","item-value"]),t(N,{class:"pr-4"},{default:a(()=>[t(r,{class:"text-right"},{default:a(()=>[t(x,{color:"success","prepend-icon":"mdi:mdi-plus",onClick:l[3]||(l[3]=e=>B())},{default:a(()=>l[13]||(l[13]=[C(" Add New Template ")])),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),i.value?(V(),S(Ee,{key:0,modelValue:R.value,"onUpdate:modelValue":l[11]||(l[11]=e=>R.value=e),title:`Edit Template${i.value.Title?` - ${i.value.Title}`:""}`,onSave:ee,onReset:Z,fullscreen:!0,scrollable:!0,"card-class":"pa-0 pa-sm-6"},{default:a(()=>[t(L,{fluid:""},{default:a(()=>[t(N,null,{default:a(()=>[t(r,{cols:"12"},{default:a(()=>[t(G,{label:"Template Title",variant:"outlined",modelValue:i.value.Title,"onUpdate:modelValue":l[4]||(l[4]=e=>i.value.Title=e),"hide-details":""},null,8,["modelValue"])]),_:1}),t(r,{cols:"12"},{default:a(()=>[t(G,{label:"Default Sender Email Address",variant:"outlined",modelValue:i.value.From,"onUpdate:modelValue":l[5]||(l[5]=e=>i.value.From=e),"hide-details":""},null,8,["modelValue"])]),_:1}),t(r,{cols:"12"},{default:a(()=>[t(G,{label:"Default Sender Name",variant:"outlined",modelValue:i.value.FromName,"onUpdate:modelValue":l[6]||(l[6]=e=>i.value.FromName=e),"hide-details":""},null,8,["modelValue"])]),_:1}),t(r,{cols:"12"},{default:a(()=>[t(G,{label:"Default Email Subject",variant:"outlined",modelValue:i.value.Subject,"onUpdate:modelValue":l[7]||(l[7]=e=>i.value.Subject=e),"hide-details":""},null,8,["modelValue"])]),_:1})]),_:1}),t(N,null,{default:a(()=>[t(r,{cols:"12"},{default:a(()=>[t(Ue,{modelValue:i.value.HTML,"onUpdate:modelValue":l[8]||(l[8]=e=>i.value.HTML=e),ref_key:"editor",ref:F},null,8,["modelValue"])]),_:1})]),_:1}),t(N,null,{default:a(()=>[t(r,{cols:"9",sm:"9"},{default:a(()=>[t(U,{modelValue:Y.value,"onUpdate:modelValue":l[9]||(l[9]=e=>Y.value=e),label:"Other Data",items:W.value,"item-title":"title","item-value":e=>e,variant:"outlined","hide-details":"",density:"compact",clearable:""},{item:a(({props:e,item:u})=>[t(J,q(e,{subtitle:u.raw.subtitle}),null,16,["subtitle"])]),selection:a(({item:e,index:u})=>[f("div",null,[C(D(e.title)+" ",1),l[14]||(l[14]=f("br",null,null,-1)),f("small",null,D(e.raw.subtitle),1)])]),_:1},8,["modelValue","items","item-value"])]),_:1}),t(r,{cols:"3",sm:"3",class:"text-right"},{default:a(()=>[t(x,{color:"primary",style:{"min-width":"40px"},onClick:ae},{default:a(()=>[t(z,{icon:"mdi:mdi-plus",class:"d-sm-none"}),l[15]||(l[15]=f("span",{class:"d-none d-sm-inline"},"Add Item",-1))]),_:1})]),_:1})]),_:1}),i.value.OwnerType===E(s).TARGET_TYPE_CONVENTION?(V(),S(N,{key:0},{default:a(()=>[t(r,{cols:"9",sm:"9"},{default:a(()=>[t(U,{modelValue:g.value,"onUpdate:modelValue":l[10]||(l[10]=e=>g.value=e),label:"Form Data",items:P.value,"item-title":"title","item-value":e=>e,variant:"outlined","hide-details":"",density:"compact",clearable:""},{item:a(({props:e,item:u})=>[t(J,q(e,{subtitle:u.raw.subtitle}),null,16,["subtitle"])]),selection:a(({item:e,index:u})=>[f("div",null,[C(D(e.title)+" ",1),l[16]||(l[16]=f("br",null,null,-1)),f("small",null,D(e.raw.subtitle),1)])]),_:1},8,["modelValue","items","item-value"])]),_:1}),t(r,{cols:"3",sm:"3",class:"text-right"},{default:a(()=>[t(x,{color:"primary",style:{"min-width":"40px"},onClick:te},{default:a(()=>[t(z,{icon:"mdi:mdi-plus",class:"d-sm-none"}),l[17]||(l[17]=f("span",{class:"d-none d-sm-inline"},"Add Field",-1))]),_:1})]),_:1})]),_:1})):y("",!0)]),_:1})]),_:1},8,["modelValue","title"])):y("",!0)]))}});export{ll as default};
