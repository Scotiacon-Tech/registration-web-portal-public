import{u as ne}from"./useTitleSetter-BmV1I3gT.js";import{P as ue}from"./permission-Ba-8wP-4.js";import{T as n,a as me}from"./targetType-BYfQr9gB.js";import{C as re,G as de}from"./canDo-BNVIjVLm.js";import{i as Z,N as ve,a0 as ee,n as f,q as y,F as d,C as pe,r as p,w as B,D as $,f as t,v as a,A as g,k as J,H as K,x as U,y as _,m as Q,G as T,P as Te,V as fe}from"./index-Dj2RVz4S.js";import{G as ce}from"./userData-B6skPaCt.js";import{_ as Ee}from"./ModelDialog.vue_vue_type_script_setup_true_lang-C75ba1NG.js";import{E as Ie}from"./Editor-COj5HvQB.js";import{b as Ne}from"./sorted-PYsDa1V2.js";import{u as Ve}from"./useConventionForms-D8ow2RCZ.js";import{u as Ue}from"./useEmailTemplates-CQGVsNmP.js";import{V as _e}from"./VSheet-DuxyNSxq.js";import{e as h,V as w,d as W}from"./VContainer-hCEkdY5X.js";import{V as O,a as u}from"./VRow-B9gMVmpX.js";import{V as b}from"./VSelect-oYoOYNcQ.js";import{V as Oe,a as X}from"./VList-YwdlYVPo.js";import{V as F}from"./VTextField-BCIF4zRI.js";import{v as Ae}from"./v4-CtRu48qb.js";import"./SaveButton.vue_vue_type_script_setup_true_lang-CkqdamWB.js";import"./forwardRefs-BAZRpoJM.js";import"./scopeId-DAGDNOpf.js";import"./createSimpleFunctional-DF_ABW_q.js";import"./VCard-RDALTcrY.js";import"./VToolbar-DbguH0aV.js";import"./VDialog-BH1VG0FI.js";import"./form-CXga_HKb.js";import"./VChip-DhmtDhNV.js";import"./VDivider-O7X7HeM5.js";const Se=A=>A===void 0?!1:re(A,de.GROUP_TYPE_SYSTEM).EditOrganisation,ge=Z({__name:"HTMLEditor",props:{modelValue:{},modelModifiers:{}},emits:["update:modelValue"],setup(A,{expose:I}){const R={license_key:"gpl",content_style:"body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }"},S=ve(A,"modelValue"),C=ee("editBox");return I({insertText:N=>{C.value&&C.value.getEditor().execCommand("mceInsertContent",!1,N)}}),(N,c)=>(f(),y(d(Ie),{modelValue:S.value,"onUpdate:modelValue":c[0]||(c[0]=i=>S.value=i),"license-key":"gpl",plugins:"advlist code emoticons link lists table",init:R,ref:"editBox"},null,8,["modelValue"]))}}),ll=Z({__name:"TemplatesView",props:{loggedIn:{type:Boolean}},async setup(A){let I,R;ne("Email Templates");const S=Te(),C=ce(),{getEmailTemplateList:H}=Ue(),{Conventions:N,Organisations:c}=([I,R]=pe(()=>S.getPermissionAccessList(ue.PERMISSION_TYPE_EDIT_CONVENTION)),I=await I,R(),I),i=p(),m=p(),D=p(!1),v=p(),r=p(n.TARGET_TYPE_SYSTEM),M=p([]),x=p(),E=p([]),le=p([{title:"Account Display Name",subtitle:"The users current profile name",value:"ACCOUNT_DISPLAY_NAME"},{title:"Email Login Recovery URL",subtitle:"One use URL for a user to access their account.",value:"ACCOUNT_RECOVERY_URL"},{title:"Convention Name",subtitle:"The convention's name",value:"CONVENTION_NAME"},{title:"Email Verification URL",subtitle:"URL used to confirm a users email address",value:"EMAIL_VERIFICATION_URL"},{title:"Organisation Name",subtitle:"The organisation's name",value:"ORGANISATION_NAME"},{title:"Payment Details",subtitle:"A list of the items being charged for and the total",value:"PAYMENT_DETAILS"},{title:"Form Name",subtitle:"Name of the form that triggered this email",value:"SUBMISSION_FORM_NAME"},{title:"Registration Reference",subtitle:"Unique reference for this registration. E.g. Badge number",value:"REGISTRATION_REFERENCE"},{title:"Submission Details",subtitle:"Auto-generated details of ticket, accommodation, cost etc.",value:"SUBMISSION_DETAILS"}]),Y=p(),G=[],L=ee("editor");Se(C)&&G.push({title:"System",value:n.TARGET_TYPE_SYSTEM}),c.length>0&&G.push({title:"Organisational",value:n.TARGET_TYPE_ORGANISATION}),N.length>0&&G.push({title:"Convention",value:n.TARGET_TYPE_CONVENTION}),B(r,()=>{r.value==n.TARGET_TYPE_SYSTEM?(m.value=void 0,v.value=void 0):r.value==n.TARGET_TYPE_ORGANISATION&&(m.value=void 0),P()}),B(v,()=>{v.value&&m.value&&v.value.OrganisationUUID!==m.value.OrganisationUUID&&(m.value=void 0),P()}),B(m,()=>{ie(),P()});const P=()=>{var o,l;return H(r.value,((o=v.value)==null?void 0:o.OrganisationUUID)||null,((l=m.value)==null?void 0:l.ConventionUUID)||null).then(e=>{E.value=e})};P();const j=()=>{var o;return{ID:0,EmailTemplateUUID:Ae(),Name:"",Title:"",OwnerUUID:r.value===n.TARGET_TYPE_SYSTEM?fe:r.value===n.TARGET_TYPE_ORGANISATION?v.value.OrganisationUUID:m.value.ConventionUUID,OwnerType:((o=me.find(l=>l.value===r.value))==null?void 0:o.value)||n.TARGET_TYPE_SYSTEM,From:"",FromName:"",Subject:"",HTML:"",AutoText:!0,Text:"",IsDefault:!1}},te=()=>{const o=E.value.findIndex(l=>i.value&&l.EmailTemplateUUID===i.value.EmailTemplateUUID);o===-1?i.value=j():i.value=J(E.value[o])},q=(o=void 0)=>{o===void 0?i.value=j():i.value=J(o),D.value=!0},ae=async o=>{if(i.value)try{const l=await S.saveEmailTemplate(i.value);if(l){const e=E.value.findIndex(s=>s.EmailTemplateUUID===l.EmailTemplateUUID);e===-1?E.value.push(l):E.value.splice(e,1,l),await o("Template Saved"),setTimeout(()=>{i.value=void 0,D.value=!1},500)}else await o("Failed to Save")}catch{await o("Failed to Save")}},z=o=>{L.value&&L.value.insertText(o)},ie=async()=>{if(!m.value)return;const o=await Ve(m.value.ConventionUUID);o&&(o.forEach(l=>l.Sections.forEach(e=>e.Fields&&M.value.push(...e.Fields.map(s=>{var V;return{subtitle:`${l.Name} - ${e.Name}`,title:`${(V=s.Field)==null?void 0:V.Name}`,value:s.SectionFieldUUID,object:s}})))),M.value.sort(Ne("title")))},oe=()=>{z(`[%FORM_${x.value.title}_${x.value.value}%]`)},se=()=>{z(`[%${Y.value.value}%]`)};return(o,l)=>(f(),$("div",null,[t(_e,null,{default:a(()=>[t(h,{class:"bg-secondary",fluid:""},{default:a(()=>[t(O,null,{default:a(()=>[t(u,{cols:"12",sm:"5",md:"3",xl:"2",class:"pa-0"},{default:a(()=>[t(b,{modelValue:r.value,"onUpdate:modelValue":l[0]||(l[0]=e=>r.value=e),label:"Level",items:G,"hide-details":""},null,8,["modelValue"])]),_:1}),r.value===d(n).TARGET_TYPE_ORGANISATION||r.value===d(n).TARGET_TYPE_CONVENTION?(f(),y(u,{key:0,cols:"12",sm:"7",md:"4",lg:"3",xl:"2",class:"pa-0"},{default:a(()=>[t(b,{modelValue:v.value,"onUpdate:modelValue":l[1]||(l[1]=e=>v.value=e),label:"Organisation",items:d(c).sort((e,s)=>e.Name.localeCompare(s.Name)),"item-title":"Name","item-value":e=>e,clearable:"","hide-details":""},null,8,["modelValue","items","item-value"])]),_:1})):g("",!0),r.value===d(n).TARGET_TYPE_CONVENTION?(f(),y(u,{key:1,cols:"12",md:"5",lg:"6",xl:"4",class:"pa-0"},{default:a(()=>[t(b,{modelValue:m.value,"onUpdate:modelValue":l[2]||(l[2]=e=>m.value=e),label:"Convention",items:d(N).filter(e=>!v.value||e.OrganisationUUID===v.value.OrganisationUUID).sort((e,s)=>e.Name.localeCompare(s.Name)),"item-title":"Name","item-value":e=>e,clearable:"","hide-details":""},null,8,["modelValue","items","item-value"])]),_:1})):g("",!0)]),_:1})]),_:1}),t(h,{fluid:""},{default:a(()=>[t(Oe,{items:E.value,"item-value":e=>e,"item-title":"Title"},{subtitle:a(({item:e})=>{var s,k;return[e.OwnerType==d(n).TARGET_TYPE_ORGANISATION?(f(),$(K,{key:0},[U(_((s=d(c).find(V=>V.OrganisationUUID===e.OwnerUUID))==null?void 0:s.Name),1)],64)):e.OwnerType==d(n).TARGET_TYPE_CONVENTION?(f(),$(K,{key:1},[U(_((k=d(N).find(V=>V.ConventionUUID===e.OwnerUUID))==null?void 0:k.Name),1)],64)):g("",!0)]}),append:a(({item:e})=>[t(w,{color:"primary","prepend-icon":"mdi:mdi-pencil",onClick:s=>q(e)},{default:a(()=>l[12]||(l[12]=[U(" Edit ")])),_:2},1032,["onClick"])]),_:1},8,["items","item-value"]),t(O,{class:"pr-4"},{default:a(()=>[t(u,{class:"text-right"},{default:a(()=>[t(w,{color:"success","prepend-icon":"mdi:mdi-plus",onClick:l[3]||(l[3]=e=>q())},{default:a(()=>l[13]||(l[13]=[U(" Add New Template ")])),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),i.value?(f(),y(Ee,{key:0,modelValue:D.value,"onUpdate:modelValue":l[11]||(l[11]=e=>D.value=e),title:`Edit Template${i.value.Title?` - ${i.value.Title}`:""}`,onSave:ae,onReset:te,fullscreen:!0,scrollable:!0,"card-class":"pa-0 pa-sm-6","retain-focus":!1},{default:a(()=>[t(h,{fluid:""},{default:a(()=>[t(O,null,{default:a(()=>[t(u,{cols:"12"},{default:a(()=>[t(F,{label:"Template Title",variant:"outlined",modelValue:i.value.Title,"onUpdate:modelValue":l[4]||(l[4]=e=>i.value.Title=e),"hide-details":""},null,8,["modelValue"])]),_:1}),t(u,{cols:"12"},{default:a(()=>[t(F,{label:"Default Sender Email Address",variant:"outlined",modelValue:i.value.From,"onUpdate:modelValue":l[5]||(l[5]=e=>i.value.From=e),"hide-details":""},null,8,["modelValue"])]),_:1}),t(u,{cols:"12"},{default:a(()=>[t(F,{label:"Default Sender Name",variant:"outlined",modelValue:i.value.FromName,"onUpdate:modelValue":l[6]||(l[6]=e=>i.value.FromName=e),"hide-details":""},null,8,["modelValue"])]),_:1}),t(u,{cols:"12"},{default:a(()=>[t(F,{label:"Default Email Subject",variant:"outlined",modelValue:i.value.Subject,"onUpdate:modelValue":l[7]||(l[7]=e=>i.value.Subject=e),"hide-details":""},null,8,["modelValue"])]),_:1})]),_:1}),t(O,null,{default:a(()=>[t(u,{cols:"12"},{default:a(()=>[t(ge,{modelValue:i.value.HTML,"onUpdate:modelValue":l[8]||(l[8]=e=>i.value.HTML=e),ref_key:"editor",ref:L},null,8,["modelValue"])]),_:1})]),_:1}),t(O,null,{default:a(()=>[t(u,{cols:"9",sm:"9"},{default:a(()=>[t(b,{modelValue:Y.value,"onUpdate:modelValue":l[9]||(l[9]=e=>Y.value=e),label:"Other Data",items:le.value,"item-title":"title","item-value":e=>e,variant:"outlined","hide-details":"",density:"compact",clearable:""},{item:a(({props:e,item:s})=>[t(X,Q(e,{subtitle:s.raw.subtitle}),null,16,["subtitle"])]),selection:a(({item:e,index:s})=>[T("div",null,[U(_(e.title)+" ",1),l[14]||(l[14]=T("br",null,null,-1)),T("small",null,_(e.raw.subtitle),1)])]),_:1},8,["modelValue","items","item-value"])]),_:1}),t(u,{cols:"3",sm:"3",class:"text-right"},{default:a(()=>[t(w,{color:"primary",style:{"min-width":"40px"},onClick:se},{default:a(()=>[t(W,{icon:"mdi:mdi-plus",class:"d-sm-none"}),l[15]||(l[15]=T("span",{class:"d-none d-sm-inline"},"Add Item",-1))]),_:1})]),_:1})]),_:1}),i.value.OwnerType===d(n).TARGET_TYPE_CONVENTION?(f(),y(O,{key:0},{default:a(()=>[t(u,{cols:"9",sm:"9"},{default:a(()=>[t(b,{modelValue:x.value,"onUpdate:modelValue":l[10]||(l[10]=e=>x.value=e),label:"Form Data",items:M.value,"item-title":"title","item-value":e=>e,variant:"outlined","hide-details":"",density:"compact",clearable:""},{item:a(({props:e,item:s})=>[t(X,Q(e,{subtitle:s.raw.subtitle}),null,16,["subtitle"])]),selection:a(({item:e,index:s})=>[T("div",null,[U(_(e.title)+" ",1),l[16]||(l[16]=T("br",null,null,-1)),T("small",null,_(e.raw.subtitle),1)])]),_:1},8,["modelValue","items","item-value"])]),_:1}),t(u,{cols:"3",sm:"3",class:"text-right"},{default:a(()=>[t(w,{color:"primary",style:{"min-width":"40px"},onClick:oe},{default:a(()=>[t(W,{icon:"mdi:mdi-plus",class:"d-sm-none"}),l[17]||(l[17]=T("span",{class:"d-none d-sm-inline"},"Add Field",-1))]),_:1})]),_:1})]),_:1})):g("",!0)]),_:1})]),_:1},8,["modelValue","title"])):g("",!0)]))}});export{ll as default};
